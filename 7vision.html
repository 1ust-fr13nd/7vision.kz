<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jetysai Earth Hybrid + Google Street View</title>

<link rel="stylesheet" href="style.css">

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>

<body>
<div id="earth"></div>
<div id="map"></div>
<div id="panorama-viewer"></div>
<div id="editor-overlay"></div>
<div id="label">–ñ–µ—Ç—ã—Å–∞–π ¬∑ –¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å ¬∑ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</div>
<button id="back-button">‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Ä—Ç–µ</button>
<button id="select-coords-btn" onclick="toggleCoordSelection()">üìç –í—ã–±—Ä–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</button>
<button id="search-streetview-btn" onclick="toggleStreetViewSearch()">üåç –ü–æ–∏—Å–∫ Street View</button>
<button id="cache-manager-btn" onclick="toggleCacheManager()">üíæ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–µ–º</button>
<div id="edit-indicator">‚úèÔ∏è –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (Ctrl+Alt+A)</div>

<!-- –ü–∞–Ω–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div id="edit-modes-panel">
    <h3>üéÆ –†–µ–∂–∏–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
    <div class="edit-mode-buttons">
        <button class="edit-mode-btn active" id="add-mode-btn" onclick="setEditMode('add')">
            <i class="fas fa-plus-circle"></i> –î–æ–±–∞–≤–ª–µ–Ω–∏–µ
        </button>
        <button class="edit-mode-btn" id="edit-mode-btn" onclick="setEditMode('edit')">
            <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        </button>
        <button class="edit-mode-btn" id="delete-mode-btn" onclick="setEditMode('delete')">
            <i class="fas fa-trash"></i> –£–¥–∞–ª–µ–Ω–∏–µ
        </button>
    </div>
</div>

<!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—ç—à–µ–º -->
<div id="cache-panel">
    <h3>üíæ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–µ–º</h3>
    <button class="cache-btn" id="export-cache-btn" onclick="saveCacheFile()">
        <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å –∫—ç—à-—Ñ–∞–π–ª
    </button>
    <button class="cache-btn" id="import-cache-btn" onclick="importCacheFile()">
        <i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫—ç—à-—Ñ–∞–π–ª
    </button>
    <button class="cache-btn" id="clear-cache-btn" onclick="clearLocalCache()">
        <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
    </button>
    <div style="margin-top:15px; padding:10px; background:rgba(156,39,176,0.1); border-radius:5px;">
        <small style="color:#ba68c8;">
            üí° –ö—ç—à-—Ñ–∞–π–ª: <strong>jetysai_panoramas_cache.json</strong><br>
            –§–∞–π–ª —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ä—è–¥–æ–º —Å —ç—Ç–∏–º —Å–∫—Ä–∏–ø—Ç–æ–º
        </small>
    </div>
</div>

<div id="streetview-panel">
    <h3>üåç –ü–æ–∏—Å–∫ Street View</h3>
    <input type="text" class="streetview-search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –º–µ—Å—Ç–æ –≤ –ñ–µ—Ç—ã—Å–∞–µ..." id="streetview-search-input">
    <div class="streetview-results" id="streetview-results">
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
    </div>
    <div style="margin-top:15px; padding:10px; background:rgba(52,168,83,0.1); border-radius:5px;">
        <small style="color:#81c995;">üí° –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–∞–Ω–æ—Ä–∞–º—ã Google Street View</small>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
<div id="coords-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üìç –í—ã–±–æ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–∞ –∫–∞—Ä—Ç–µ</h2>
            <p>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è, –∑–∞—Ç–µ–º –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤—ã–±–æ—Ä</p>
        </div>
        <div class="modal-body">
            <div id="modal-map-container">
                <div id="modal-map"></div>
            </div>
            <div class="modal-info">
                <div class="coords-display">
                    <h4>–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</h4>
                    <div id="selected-coords">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</div>
                </div>
                <div class="coords-instructions">
                    <h4>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</h4>
                    <ul>
                        <li><strong>–ö–ª–∏–∫–Ω–∏—Ç–µ</strong> –Ω–∞ –∫–∞—Ä—Ç–µ –≤ –Ω—É–∂–Ω–æ–º –º–µ—Å—Ç–µ</li>
                        <li><strong>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ</strong> –º–∞—Ä–∫–µ—Ä –¥–ª—è —Ç–æ—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</li>
                        <li><strong>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–ª–µ—Å–æ –º—ã—à–∏</strong> –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è/—É–º–µ–Ω—å—à–µ–Ω–∏—è</li>
                        <li><strong>–ó–∞–∂–º–∏—Ç–µ –ª–µ–≤—É—é –∫–Ω–æ–ø–∫—É –º—ã—à–∏</strong> –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –ø–æ –∫–∞—Ä—Ç–µ</li>
                        <li><strong>–ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å"</strong> –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn" id="cancel-modal-btn" onclick="closeCoordsModal()">
                <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∏—Ç—å
            </button>
            <button class="modal-btn" id="confirm-modal-btn" onclick="confirmCoordsSelection()">
                <i class="fas fa-check"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä
            </button>
        </div>
    </div>
</div>

<div id="editor-console">
    <button class="console-close" onclick="closeConsole()">√ó</button>
    <div id="console-content"></div>
</div>
<div id="loading">
    <div class="loading-spinner"></div>
    –ó–∞–≥—Ä—É–∑–∫–∞ 3D –ó–µ–º–ª–∏...
</div>

<script>
// ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
let map = null;
let earthScene = null;
let currentView = 'earth';
let panoramaScene = null;
let currentPanorama = null;
let editMode = false;
let selectedLocation = null;
let editHistory = [];
let currentHistoryIndex = -1;
let selectingCoords = false;
let coordMarker = null;
let currentEditPanorama = null;
let streetViewSearchMode = false;
let currentEditMode = 'add';
let cacheManagerOpen = false;
let userLocationMarker = null;
let userLocation = null;
let panoramaMarkers = {}; // –•—Ä–∞–Ω–∏–ª–∏—â–µ –º–∞—Ä–∫–µ—Ä–æ–≤

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
let modalMap = null;
let modalMarker = null;
let modalSelectedLocation = null;

// ========== –°–ò–°–¢–ï–ú–ê –ö–≠–®–ò–†–û–í–ê–ù–ò–Ø ==========
const CACHE_FILE_NAME = 'jetysai_panoramas_cache.json';
let cacheFilePath = '';

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –∫—ç—à–∞
function getCacheFilePath() {
    try {
        const scripts = document.getElementsByTagName('script');
        const currentScript = scripts[scripts.length - 1];
        const scriptPath = currentScript.src || window.location.href;
        
        if (scriptPath.includes('http')) {
            const url = new URL(scriptPath);
            const pathParts = url.pathname.split('/');
            pathParts.pop();
            return url.origin + pathParts.join('/') + '/' + CACHE_FILE_NAME;
        } else {
            const pathParts = window.location.pathname.split('/');
            pathParts.pop();
            return window.location.origin + pathParts.join('/') + '/' + CACHE_FILE_NAME;
        }
    } catch (e) {
        return CACHE_FILE_NAME;
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫
function cleanPanoramaData(data) {
    if (!Array.isArray(data)) return [];
    
    return data.map(pano => {
        const cleanPano = {
            id: pano.id || Date.now(),
            name: pano.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
            description: pano.description || '',
            location: Array.isArray(pano.location) ? pano.location : 
                     (pano.lat && pano.lng) ? [pano.lat, pano.lng] : [40.77, 68.3],
            date: pano.date || '–ù–µ —É–∫–∞–∑–∞–Ω–∞',
            imageUrl: pano.imageUrl || '',
            details: pano.details || '',
            icon: pano.icon || 'üèõÔ∏è',
            source: pano.source || 'user',
            panoId: pano.panoId || `user_${Date.now()}`
        };
        
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏
        Object.keys(cleanPano).forEach(key => {
            if (cleanPano[key] && typeof cleanPano[key] === 'object') {
                if (cleanPano[key]._leaflet_id || cleanPano[key]._map || cleanPano[key]._popup) {
                    delete cleanPano[key];
                }
            }
        });
        
        return cleanPano;
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫—ç—à-—Ñ–∞–π–ª–∞
async function loadFromCacheFile() {
    try {
        cacheFilePath = getCacheFilePath();
        console.log(`üîç –ò—â—É –∫—ç—à-—Ñ–∞–π–ª –ø–æ –ø—É—Ç–∏: ${cacheFilePath}`);
        
        const response = await fetch(cacheFilePath + '?t=' + Date.now());
        
        if (response.ok) {
            const data = await response.json();
            if (data && Array.isArray(data.panoramas)) {
                panoramas = cleanPanoramaData(data.panoramas);
                logToConsole(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${panoramas.length} –ø–∞–Ω–æ—Ä–∞–º –∏–∑ –∫—ç—à-—Ñ–∞–π–ª–∞`, 'success');
                return true;
            }
        }
        return false;
    } catch (error) {
        console.log('‚ùå –§–∞–π–ª –∫—ç—à–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error.message);
        return false;
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –∫—ç—à-—Ñ–∞–π–ª
async function saveCacheFile() {
    try {
        // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
        const cleanPanoramas = cleanPanoramaData(panoramas);
        
        const cacheData = {
            version: '2.0',
            lastModified: new Date().toISOString(),
            generatedBy: 'Jetysai Earth Hybrid',
            panoramas: cleanPanoramas
        };
        
        const jsonStr = JSON.stringify(cacheData, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = CACHE_FILE_NAME;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –≤ localStorage
        localStorage.setItem('panoramas_cache_backup', jsonStr);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        showCacheDownloadLink(url);
        
        logToConsole(`üíæ –ö—ç—à-—Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω (${panoramas.length} –æ–±—ä–µ–∫—Ç–æ–≤)`, 'success');
        showNotification(`üíæ –ö—ç—à-—Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω: ${CACHE_FILE_NAME}`);
        
        return true;
    } catch (error) {
        logToConsole(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—ç—à-—Ñ–∞–π–ª–∞: ${error.message}`, 'error');
        
        // –ü—Ä–æ–±—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –º–µ—Ç–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        try {
            await saveCacheFileSimple();
        } catch (altError) {
            logToConsole(`‚ùå –ü—Ä–æ—Å—Ç–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∂–µ –Ω–µ —É–¥–∞–ª–æ—Å—å`, 'error');
        }
        
        return false;
    }
}

// –ü—Ä–æ—Å—Ç–æ–π –º–µ—Ç–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
async function saveCacheFileSimple() {
    const simplePanoramas = panoramas.map(p => ({
        id: p.id,
        name: p.name,
        description: p.description,
        location: Array.isArray(p.location) ? p.location : [p.location?.lat || 40.77, p.location?.lng || 68.3],
        date: p.date,
        imageUrl: p.imageUrl,
        details: p.details,
        icon: p.icon,
        source: p.source,
        panoId: p.panoId
    }));
    
    const cacheData = {
        version: '2.0-simple',
        lastModified: new Date().toISOString(),
        generatedBy: 'Jetysai Earth Hybrid',
        panoramas: simplePanoramas
    };
    
    const jsonStr = JSON.stringify(cacheData, null, 2);
    const blob = new Blob([jsonStr], { type: 'application/json;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = CACHE_FILE_NAME;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    localStorage.setItem('panoramas_cache_simple', jsonStr);
    
    logToConsole('üíæ –ö—ç—à-—Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥)', 'success');
    return true;
}

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∫—ç—à–∞
function showCacheDownloadLink(url) {
    const existingLink = document.getElementById('cache-download-link');
    if (existingLink) {
        existingLink.remove();
    }
    
    const linkDiv = document.createElement('div');
    linkDiv.id = 'cache-download-link';
    linkDiv.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 100, 0, 0.9);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        z-index: 10000;
        border: 2px solid #00ff00;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        max-width: 300px;
    `;
    
    linkDiv.innerHTML = `
        <strong>üíæ –ö—ç—à-—Ñ–∞–π–ª –≥–æ—Ç–æ–≤!</strong><br>
        <small>–°–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª –∏ –ø–æ–º–µ—Å—Ç–∏—Ç–µ —Ä—è–¥–æ–º —Å HTML-—Ñ–∞–π–ª–æ–º:</small><br>
        <a href="${url}" download="${CACHE_FILE_NAME}" 
           style="color: #00ffff; font-weight: bold; word-break: break-all;">
           ${CACHE_FILE_NAME}
        </a><br>
        <small style="color:#90ff90;">–ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è –∏–∑ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞</small><br>
        <button onclick="this.parentNode.remove()" 
                style="margin-top:10px; background:#ff4444; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:12px;">
            ‚úï –ó–∞–∫—Ä—ã—Ç—å
        </button>
    `;
    
    document.body.appendChild(linkDiv);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫—ç—à-—Ñ–∞–π–ª–∞
function importCacheFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.style.display = 'none';
    
    input.onchange = async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data && Array.isArray(data.panoramas)) {
                    panoramas = cleanPanoramaData(data.panoramas);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
                    localStorage.setItem('panoramas_cache_backup', JSON.stringify(data));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
                    updatePanoramasOnMap();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    logToConsole(`‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${panoramas.length} –ø–∞–Ω–æ—Ä–∞–º –∏–∑ —Ñ–∞–π–ª–∞`, 'success');
                    showNotification(`‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${panoramas.length} –ø–∞–Ω–æ—Ä–∞–º`);
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∫—ç—à–∞
                    toggleCacheManager();
                } else {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                }
            } catch (error) {
                logToConsole('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message, 'error');
                showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞', 'error');
            }
        };
        reader.readAsText(file);
    };
    
    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);
}

// –û—á–∏—Å—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∞
function clearLocalCache() {
    if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –Ω–µ —É–¥–∞–ª–∏—Ç –∫—ç—à-—Ñ–∞–π–ª.')) {
        localStorage.removeItem('panoramas_cache_backup');
        localStorage.removeItem('panoramas_cache_simple');
        panoramas = [];
        panoramaMarkers = {};
        updatePanoramasOnMap();
        logToConsole('üóëÔ∏è –õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –æ—á–∏—â–µ–Ω', 'warning');
        showNotification('üóëÔ∏è –õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –æ—á–∏—â–µ–Ω');
        toggleCacheManager();
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—ç—à–µ–º
function toggleCacheManager() {
    cacheManagerOpen = !cacheManagerOpen;
    const panel = document.getElementById('cache-panel');
    const btn = document.getElementById('cache-manager-btn');
    
    if (cacheManagerOpen) {
        panel.style.display = 'block';
        btn.style.background = 'rgba(156,39,176,1)';
        btn.style.borderColor = '#9c27b0';
    } else {
        panel.style.display = 'none';
        btn.style.background = 'rgba(156,39,176,0.9)';
        btn.style.borderColor = '#9c27b0';
    }
}

// ========== –ë–ê–ó–ê –î–ê–ù–ù–´–• –ü–ê–ù–û–†–ê–ú ==========
let panoramas = [];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
async function initializePanoramas() {
    console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...');
    
    // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –∫—ç—à-—Ñ–∞–π–ª–∞
    await loadFromCacheFile();
    
    // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
    if (panoramas.length === 0) {
        logToConsole('üìù –ö—ç—à-—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –î–æ–±–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏ –ø–∞–Ω–æ—Ä–∞–º—ã', 'info');
    }
    
    logToConsole('‚úÖ –°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞', 'success');
}

// ========== –ì–ï–û–õ–û–ö–ê–¶–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ==========
function setupUserLocation() {
    if (!navigator.geolocation) {
        logToConsole('‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º', 'error');
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
            };
            
            logToConsole(`üìç –í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}`, 'success');
            
            addUserLocationMarker();
            startLocationTracking();
        },
        function(error) {
            logToConsole('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ' + error.message, 'error');
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
function addUserLocationMarker() {
    if (!map || !userLocation) return;
    
    if (userLocationMarker) {
        map.removeLayer(userLocationMarker);
    }
    
    const locationIcon = L.divIcon({
        html: `
            <div class="location-marker">
                <div class="icon">
                    <i class="fas fa-user"></i>
                </div>
            </div>`,
        iconSize: [35, 35],
        iconAnchor: [17.5, 17.5],
        className: 'user-location-icon'
    });
    
    userLocationMarker = L.marker([userLocation.lat, userLocation.lng], {
        icon: locationIcon,
        title: "–í–∞—à–µ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ",
        zIndexOffset: 2000
    }).addTo(map);
    
    userLocationMarker.bindPopup(`
        <div style="text-align:center;">
            <h4 style="margin:0 0 5px 0; color:#4285f4;">üìç –í—ã –∑–¥–µ—Å—å</h4>
            <p style="margin:0; font-size:12px;">
                –®–∏—Ä–æ—Ç–∞: ${userLocation.lat.toFixed(6)}<br>
                –î–æ–ª–≥–æ—Ç–∞: ${userLocation.lng.toFixed(6)}
            </p>
            <small style="color:#666;">–¢–æ—á–Ω–æ—Å—Ç—å: ¬±${Math.round(userLocation.accuracy)} –º</small>
        </div>
    `);
    
    if (panoramas.length === 0) {
        map.setView([userLocation.lat, userLocation.lng], 15);
    }
}

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
function startLocationTracking() {
    if (!navigator.geolocation) return;
    
    navigator.geolocation.watchPosition(
        function(position) {
            const newLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
            };
            
            if (!userLocation || 
                Math.abs(userLocation.lat - newLocation.lat) > 0.0001 ||
                Math.abs(userLocation.lng - newLocation.lng) > 0.0001) {
                
                userLocation = newLocation;
                
                if (userLocationMarker && map) {
                    userLocationMarker.setLatLng([userLocation.lat, userLocation.lng]);
                } else {
                    addUserLocationMarker();
                }
            }
        },
        function(error) {
            console.log('–û—à–∏–±–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è:', error.message);
        },
        {
            enableHighAccuracy: true,
            maximumAge: 10000,
            timeout: 15000
        }
    );
}

// ========== –†–ï–ñ–ò–ú–´ –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ==========
function setEditMode(mode) {
    currentEditMode = mode;
    
    document.querySelectorAll('.edit-mode-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    switch(mode) {
        case 'add':
            document.getElementById('add-mode-btn').classList.add('active');
            logToConsole('‚ûï –†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤', 'info');
            showNotification('‚ûï –†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ');
            break;
        case 'edit':
            document.getElementById('edit-mode-btn').classList.add('active');
            logToConsole('‚úèÔ∏è –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤', 'info');
            showNotification('‚úèÔ∏è –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –æ–±—ä–µ–∫—Ç–µ');
            break;
        case 'delete':
            document.getElementById('delete-mode-btn').classList.add('active');
            logToConsole('üóëÔ∏è –†–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤', 'warning');
            showNotification('üóëÔ∏è –†–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è: –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –æ–±—ä–µ–∫—Ç–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
            break;
    }
}

// ========== –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò ==========
let keysPressed = {};

function setupHotkeys() {
    document.addEventListener('keydown', function(e) {
        keysPressed[e.key.toLowerCase()] = true;
        
        if ((e.ctrlKey || e.metaKey) && e.altKey && e.key.toLowerCase() === 'a') {
            e.preventDefault();
            if (!editMode && currentView === 'map') {
                activateEditMode();
            } else if (editMode) {
                deactivateEditMode();
            }
        }
        
        if (editMode) {
            if (e.key === '1') {
                e.preventDefault();
                setEditMode('add');
            }
            else if (e.key === '2') {
                e.preventDefault();
                setEditMode('edit');
            }
            else if (e.key === '3') {
                e.preventDefault();
                setEditMode('delete');
            }
            else if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
                e.preventDefault();
                saveCacheFile();
            }
        }
        
        if (e.key === 'Escape') {
            if (document.getElementById('coords-modal').classList.contains('active')) {
                closeCoordsModal();
            } else if (currentView === 'panorama') {
                closePanorama();
            } else if (editMode) {
                deactivateEditMode();
                closeEditor();
            } else if (cacheManagerOpen) {
                toggleCacheManager();
            }
        }
    });
    
    document.addEventListener('keyup', function(e) {
        delete keysPressed[e.key.toLowerCase()];
    });
}

// –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function activateEditMode() {
    editMode = true;
    document.getElementById('edit-indicator').style.display = 'block';
    document.getElementById('select-coords-btn').style.display = 'block';
    document.getElementById('search-streetview-btn').style.display = 'block';
    document.getElementById('cache-manager-btn').style.display = 'block';
    document.getElementById('edit-modes-panel').style.display = 'block';
    logToConsole('‚úèÔ∏è –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω (Ctrl+Alt+A)', 'success');
    showNotification('‚úèÔ∏è –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
    setEditMode('add');
}

// –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function deactivateEditMode() {
    editMode = false;
    currentEditMode = 'add';
    document.getElementById('edit-indicator').style.display = 'none';
    document.getElementById('select-coords-btn').style.display = 'none';
    document.getElementById('search-streetview-btn').style.display = 'none';
    document.getElementById('cache-manager-btn').style.display = 'none';
    document.getElementById('edit-modes-panel').style.display = 'none';
    document.getElementById('streetview-panel').style.display = 'none';
    document.getElementById('cache-panel').style.display = 'none';
    streetViewSearchMode = false;
    cacheManagerOpen = false;
    closeEditor();
    logToConsole('‚úÖ –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω', 'info');
    showNotification('‚úÖ –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'success' ? 'rgba(0,255,0,0.9)' : 
                    type === 'error' ? 'rgba(255,0,0,0.9)' : 
                    type === 'warning' ? 'rgba(255,170,0,0.9)' : 
                    'rgba(66,133,244,0.9)'};
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        z-index: 3001;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        font-weight: bold;
        animation: slideIn 0.3s ease;
    `;
    
    notification.innerHTML = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(-50%) translateY(0); opacity: 1; }
        to { transform: translateX(-50%) translateY(-100px); opacity: 0; }
    }
`;
document.head.appendChild(style);

// ========== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –í–´–ë–û–†–ê –ö–û–û–†–î–ò–ù–ê–¢ ==========
function openCoordsModal() {
    if (!editMode) {
        showNotification('‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (Ctrl+Alt+A)', 'error');
        return;
    }
    
    modalSelectedLocation = selectedLocation;
    document.getElementById('coords-modal').classList.add('active');
    setTimeout(() => {
        initModalMap();
    }, 100);
}

function closeCoordsModal() {
    document.getElementById('coords-modal').classList.remove('active');
    if (modalMap) {
        modalMap.remove();
        modalMap = null;
    }
    modalMarker = null;
}

function initModalMap() {
    const modalMapContainer = document.getElementById('modal-map');
    if (!modalMapContainer) return;
    
    modalMapContainer.innerHTML = '';
    
    modalMap = L.map('modal-map', {
        zoomControl: true,
        attributionControl: false,
        dragging: true
    }).setView([40.77, 68.3], 13);
    
    const satelliteWithLabels = L.tileLayer('http://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: ''
    });
    
    const regularMap = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: ''
    });
    
    satelliteWithLabels.addTo(modalMap);
    
    L.control.layers({
        "üõ∞Ô∏è –°–ø—É—Ç–Ω–∏–∫": satelliteWithLabels,
        "üó∫Ô∏è –û–±—ã—á–Ω–∞—è –∫–∞—Ä—Ç–∞": regularMap
    }, null, {
        collapsed: false,
        position: 'topright'
    }).addTo(modalMap);
    
    L.control.scale({
        position: 'bottomright',
        imperial: false,
        metric: true
    }).addTo(modalMap);
    
    modalMap.on('click', function(e) {
        modalSelectedLocation = e.latlng;
        document.getElementById('selected-coords').innerHTML = 
            `${modalSelectedLocation.lat.toFixed(6)}, ${modalSelectedLocation.lng.toFixed(6)}`;
        
        if (modalMarker) {
            modalMap.removeLayer(modalMarker);
        }
        
        modalMarker = L.marker(modalSelectedLocation, {
            draggable: true,
            title: "–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã"
        }).addTo(modalMap);
        
        modalMarker.on('dragend', function(e) {
            const marker = e.target;
            const position = marker.getLatLng();
            modalSelectedLocation = position;
            document.getElementById('selected-coords').innerHTML = 
                `${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}`;
        });
    });
    
    if (selectedLocation) {
        modalMap.setView([selectedLocation.lat, selectedLocation.lng], 15);
        modalSelectedLocation = selectedLocation;
        document.getElementById('selected-coords').innerHTML = 
            `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
        
        modalMarker = L.marker(selectedLocation, {
            draggable: true,
            title: "–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã"
        }).addTo(modalMap);
        
        modalMarker.on('dragend', function(e) {
            const marker = e.target;
            const position = marker.getLatLng();
            modalSelectedLocation = position;
            document.getElementById('selected-coords').innerHTML = 
                `${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}`;
        });
    }
}

function confirmCoordsSelection() {
    if (modalSelectedLocation) {
        selectedLocation = modalSelectedLocation;
        const coordsInput = document.getElementById('pano-coords');
        if (coordsInput) {
            coordsInput.value = `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
        }
        logToConsole(`üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: ${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`, 'success');
    }
    closeCoordsModal();
}

// ========== –†–ï–ñ–ò–ú –í–´–ë–û–†–ê –ö–û–û–†–î–ò–ù–ê–¢ ==========
function toggleCoordSelection() {
    openCoordsModal();
}

// ========== –ü–û–ò–°–ö GOOGLE STREET VIEW ==========
function toggleStreetViewSearch() {
    if (!editMode) {
        showNotification('‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (Ctrl+Alt+A)', 'error');
        return;
    }
    
    streetViewSearchMode = !streetViewSearchMode;
    const panel = document.getElementById('streetview-panel');
    const btn = document.getElementById('search-streetview-btn');
    
    if (streetViewSearchMode) {
        panel.style.display = 'block';
        btn.style.background = 'rgba(52,168,83,1)';
        btn.style.borderColor = '#34a853';
        loadStreetViewPoints();
    } else {
        panel.style.display = 'none';
        btn.style.background = 'rgba(66,133,244,0.9)';
        btn.style.borderColor = '#4285f4';
    }
}

function loadStreetViewPoints() {
    const resultsDiv = document.getElementById('streetview-results');
    resultsDiv.innerHTML = '';
    const streetViewPanos = panoramas.filter(p => p.source === 'google');
    
    if (streetViewPanos.length === 0) {
        resultsDiv.innerHTML = '<div class="streetview-result-item" style="color:#aaa;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–∞–Ω–æ—Ä–∞–º Street View</div>';
        return;
    }
    
    streetViewPanos.forEach(pano => {
        const item = document.createElement('div');
        item.className = 'streetview-result-item';
        item.innerHTML = `<strong>${pano.icon} ${pano.name}</strong><br><small>${pano.description}</small>`;
        item.onclick = () => selectStreetViewPano(pano);
        resultsDiv.appendChild(item);
    });
}

function selectStreetViewPano(pano) {
    openPanorama(pano.id);
    toggleStreetViewSearch();
}

// ========== –†–ï–î–ê–ö–¢–û–† –ü–ê–ù–û–†–ê–ú ==========
function openEditor(latLng = null, panoramaToEdit = null) {
    if (!editMode) {
        showNotification('‚ùå –°–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (Ctrl+Alt+A)', 'error');
        return;
    }
    
    selectedLocation = latLng;
    currentEditPanorama = panoramaToEdit;
    
    document.getElementById('editor-overlay').style.display = 'block';
    
    if (selectingCoords) toggleCoordSelection();
    if (streetViewSearchMode) toggleStreetViewSearch();
    if (cacheManagerOpen) toggleCacheManager();
    
    setTimeout(() => {
        document.getElementById('editor-overlay').style.opacity = '1';
    }, 10);
    
    const isEditMode = panoramaToEdit !== null;
    const isGooglePano = panoramaToEdit && panoramaToEdit.source === 'google';
    const title = isEditMode ? '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞–Ω–æ—Ä–∞–º—É' : '‚úèÔ∏è –î–æ–±–∞–≤–∏—Ç—å 360¬∞ –ü–∞–Ω–æ—Ä–∞–º—É';
    
    const editorHTML = `
        <div class="editor-container">
            <h2>${title}</h2>
            
            <div style="margin-bottom:20px; padding:15px; background:rgba(255,170,0,0.1); border-radius:8px; border:2px solid #ffaa00;">
                <h4 style="color:#ffaa00; margin:0 0 10px 0;">üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º</h4>
                <p style="margin:0; color:#ffcc80;">
                    <strong>–¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: ${currentEditMode === 'add' ? '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ' : currentEditMode === 'edit' ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' : '–£–¥–∞–ª–µ–Ω–∏–µ'}</strong><br>
                    ‚Ä¢ <strong>1</strong> - –†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è<br>
                    ‚Ä¢ <strong>2</strong> - –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è<br>
                    ‚Ä¢ <strong>3</strong> - –†–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è<br>
                    ‚Ä¢ <strong>Ctrl+S</strong> - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫—ç—à<br>
                    ‚Ä¢ <strong>Ctrl+Alt+A</strong> - –í—ã–π—Ç–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                </p>
            </div>
            
            ${isGooglePano ? `
            <div style="margin-bottom:20px; padding:15px; background:rgba(52,168,83,0.1); border-radius:8px; border:2px solid #34a853;">
                <h4 style="color:#34a853; margin:0 0 10px 0;">üåç –ü–∞–Ω–æ—Ä–∞–º–∞ Google Street View</h4>
                <p style="margin:0; color:#81c995;">–≠—Ç–∞ –ø–∞–Ω–æ—Ä–∞–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ Google Street View. –í—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –µ—ë –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–π –ø–∞–Ω–æ—Ä–∞–º—ã.</p>
            </div>
            ` : ''}
            
            <div class="form-group">
                <label for="pano-name">–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞:</label>
                <input type="text" id="pano-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å" required
                    value="${isEditMode ? panoramaToEdit.name : ''}">
            </div>
            
            <div class="form-group">
                <label for="pano-description">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea id="pano-description" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–µ—Å—Ç–∞..." required>${isEditMode ? panoramaToEdit.description : ''}</textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="pano-icon">–ò–∫–æ–Ω–∫–∞:</label>
                    <select id="pano-icon">
                        <option value="üèõÔ∏è" ${isEditMode && panoramaToEdit.icon === 'üèõÔ∏è' ? 'selected' : ''}>üèõÔ∏è –ó–¥–∞–Ω–∏–µ</option>
                        <option value="üåä" ${isEditMode && panoramaToEdit.icon === 'üåä' ? 'selected' : ''}>üåä –†–µ–∫–∞/–í–æ–¥–æ–µ–º</option>
                        <option value="üõí" ${isEditMode && panoramaToEdit.icon === 'üõí' ? 'selected' : ''}>üõí –†—ã–Ω–æ–∫/–ú–∞–≥–∞–∑–∏–Ω</option>
                        <option value="üå≥" ${isEditMode && panoramaToEdit.icon === 'üå≥' ? 'selected' : ''}>üå≥ –ü–∞—Ä–∫/–°–∫–≤–µ—Ä</option>
                        <option value="üöÇ" ${isEditMode && panoramaToEdit.icon === 'üöÇ' ? 'selected' : ''}>üöÇ –í–æ–∫–∑–∞–ª</option>
                        <option value="üè´" ${isEditMode && panoramaToEdit.icon === 'üè´' ? 'selected' : ''}>üè´ –®–∫–æ–ª–∞</option>
                        <option value="üè•" ${isEditMode && panoramaToEdit.icon === 'üè•' ? 'selected' : ''}>üè• –ë–æ–ª—å–Ω–∏—Ü–∞</option>
                        <option value="üïå" ${isEditMode && panoramaToEdit.icon === 'üïå' ? 'selected' : ''}>üïå –ú–µ—á–µ—Ç—å</option>
                        <option value="üè®" ${isEditMode && panoramaToEdit.icon === 'üè®' ? 'selected' : ''}>üè® –ì–æ—Å—Ç–∏–Ω–∏—Ü–∞</option>
                        <option value="‚öΩ" ${isEditMode && panoramaToEdit.icon === '‚öΩ' ? 'selected' : ''}>‚öΩ –°—Ç–∞–¥–∏–æ–Ω</option>
                        <option value="üåç" ${isEditMode && panoramaToEdit.icon === 'üåç' ? 'selected' : !isEditMode ? 'selected' : ''}>üåç Street View</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="pano-date">–î–∞—Ç–∞ —Å—ä–µ–º–∫–∏:</label>
                    <input type="text" id="pano-date" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–µ–Ω—Ç—è–±—Ä—å 2023" required
                        value="${isEditMode ? panoramaToEdit.date : ''}">
                </div>
            </div>
            
            <div class="form-group">
                <label for="pano-details">–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏:</label>
                <textarea id="pano-details" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–µ—Å—Ç–∞, –∏—Å—Ç–æ—Ä–∏—è, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏...">${isEditMode ? panoramaToEdit.details : ''}</textarea>
            </div>
            
            <div class="form-group">
                <label for="pano-coords">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</label>
                <input type="text" id="pano-coords" readonly 
                    value="${latLng ? `${latLng.lat.toFixed(6)}, ${latLng.lng.toFixed(6)}` : isEditMode ? `${panoramaToEdit.location[0].toFixed(6)}, ${panoramaToEdit.location[1].toFixed(6)}` : '–ù–∞–∂–º–∏—Ç–µ "–í—ã–±—Ä–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã"'}">
                <div style="margin-top:8px; display:flex; gap:10px;">
                    <button onclick="openCoordsModal()" style="
                        background:#ffaa00;
                        color:black;
                        border:none;
                        padding:8px 15px;
                        border-radius:5px;
                        cursor:pointer;
                        font-size:14px;
                        flex:1;
                    ">
                        <i class="fas fa-map-marker-alt"></i> –í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ
                    </button>
                    <button onclick="useCurrentLocation()" style="
                        background:#4285f4;
                        color:white;
                        border:none;
                        padding:8px 15px;
                        border-radius:5px;
                        cursor:pointer;
                        font-size:14px;
                        flex:1;
                    ">
                        <i class="fas fa-location-arrow"></i> –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="pano-image">360¬∞ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è:</label>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button onclick="document.getElementById('pano-image').click()" style="
                        background:#00ffff;
                        color:black;
                        border:none;
                        padding:10px 15px;
                        border-radius:5px;
                        cursor:pointer;
                        flex:1;
                    ">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
                    <button onclick="searchInStreetView()" style="
                        background:#34a853;
                        color:white;
                        border:none;
                        padding:10px 15px;
                        border-radius:5px;
                        cursor:pointer;
                        flex:1;
                    ">üåç –ù–∞–π—Ç–∏ –≤ Street View</button>
                </div>
                <input type="file" id="pano-image" accept="image/*" style="display:none;">
                <small style="color:#aaa;">–í—ã–±–µ—Ä–∏—Ç–µ 360¬∞ —Ñ–æ—Ç–æ –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –≤ Google Street View</small>
                <img id="image-preview" class="preview-image" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" 
                    src="${isEditMode ? panoramaToEdit.imageUrl : ''}" 
                    style="${isEditMode ? 'display:block;' : 'display:none;'}">
            </div>
            
            <div class="form-group">
                <label for="pano-image-url">URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
                <input type="url" id="pano-image-url" placeholder="https://example.com/panorama.jpg"
                    value="${isEditMode ? panoramaToEdit.imageUrl : ''}">
                <button onclick="loadImageFromURL()" style="
                    background:#00ff88;
                    color:black;
                    border:none;
                    padding:8px 15px;
                    border-radius:5px;
                    cursor:pointer;
                    margin-top:8px;
                    width:100%;
                ">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ URL</button>
            </div>
            
            <div class="editor-buttons">
                <button class="editor-btn" id="save-btn">
                    ${isEditMode ? 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞–Ω–æ—Ä–∞–º—É'}
                </button>
                <button class="editor-btn" id="cancel-btn">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
                <button class="editor-btn" onclick="saveCacheFile()" 
                        style="background:linear-gradient(135deg, #9c27b0, #673ab7); color:white;">
                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫—ç—à
                </button>
                ${isEditMode ? `
                <button class="editor-btn" id="delete-btn" style="background:linear-gradient(135deg, #ff4444, #cc0000); color:white;">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                </button>
                ` : ''}
            </div>
        </div>
    `;
    
    document.getElementById('editor-overlay').innerHTML = editorHTML;
    
    if (latLng && !isEditMode) {
        selectedLocation = latLng;
        document.getElementById('pano-coords').value = `${latLng.lat.toFixed(6)}, ${latLng.lng.toFixed(6)}`;
    } else if (isEditMode) {
        selectedLocation = { lat: panoramaToEdit.location[0], lng: panoramaToEdit.location[1] };
    }
    
    document.getElementById('pano-image').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('image-preview');
                img.src = e.target.result;
                img.style.display = 'block';
                document.getElementById('pano-image-url').value = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    });
    
    document.getElementById('save-btn').addEventListener('click', function() {
        savePanorama(isEditMode);
    });
    
    document.getElementById('cancel-btn').addEventListener('click', closeEditor);
    
    if (isEditMode) {
        document.getElementById('delete-btn').addEventListener('click', function() {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø–∞–Ω–æ—Ä–∞–º—É "${panoramaToEdit.name}"?`)) {
                deletePanorama(panoramaToEdit.id);
            }
        });
    }
}

function useCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            selectedLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            document.getElementById('pano-coords').value = 
                `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
            logToConsole(`üìç –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ`, 'success');
        }, function(error) {
            logToConsole('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', 'error');
        });
    } else {
        logToConsole('‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
    }
}

function searchInStreetView() {
    toggleStreetViewSearch();
}

function loadImageFromURL() {
    const url = document.getElementById('pano-image-url').value;
    if (!url) {
        logToConsole('‚ùå –í–≤–µ–¥–∏—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
        return;
    }
    const img = document.getElementById('image-preview');
    img.src = url;
    img.style.display = 'block';
    img.onload = function() {
        logToConsole('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
    };
    img.onerror = function() {
        logToConsole('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'error');
    };
}

// ========== –§–£–ù–ö–¶–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –ü–ê–ù–û–†–ê–ú–´ ==========
function savePanorama(isEdit = false) {
    const name = document.getElementById('pano-name').value;
    const description = document.getElementById('pano-description').value;
    const icon = document.getElementById('pano-icon').value;
    const date = document.getElementById('pano-date').value;
    const details = document.getElementById('pano-details').value;
    const coords = document.getElementById('pano-coords').value;
    const imageUrl = document.getElementById('pano-image-url').value;
    const imageInput = document.getElementById('pano-image');
    
    if (!name || !description || !date) {
        showNotification('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!', 'error');
        return;
    }
    
    if (!coords || !coords.includes(',')) {
        showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ!', 'error');
        return;
    }
    
    let parsedCoords;
    try {
        parsedCoords = coords.split(',').map(c => parseFloat(c.trim()));
        if (parsedCoords.length !== 2 || isNaN(parsedCoords[0]) || isNaN(parsedCoords[1])) {
            throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç');
        }
    } catch (e) {
        showNotification('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç!', 'error');
        return;
    }
    
    let finalImageUrl = imageUrl;
    const imageFile = imageInput.files[0];
    
    if (imageFile && !imageUrl.startsWith('data:')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            finalImageUrl = e.target.result;
            completeSave(name, description, icon, date, details, parsedCoords, finalImageUrl, isEdit);
        };
        reader.readAsDataURL(imageFile);
    } else {
        completeSave(name, description, icon, date, details, parsedCoords, finalImageUrl, isEdit);
    }
}

function completeSave(name, description, icon, date, details, coords, imageUrl, isEdit) {
    if (isEdit && currentEditPanorama) {
        const index = panoramas.findIndex(p => p.id === currentEditPanorama.id);
        if (index !== -1) {
            panoramas[index] = {
                id: currentEditPanorama.id,
                name: name,
                description: description,
                icon: icon,
                date: date,
                details: details,
                location: coords,
                imageUrl: imageUrl,
                source: currentEditPanorama.source || "user",
                panoId: currentEditPanorama.panoId || `user_${Date.now()}`
            };
            
            logToConsole(`‚úèÔ∏è –ü–∞–Ω–æ—Ä–∞–º–∞ "${name}" –æ–±–Ω–æ–≤–ª–µ–Ω–∞`, 'success');
            showNotification(`‚úÖ –ü–∞–Ω–æ—Ä–∞–º–∞ "${name}" –æ–±–Ω–æ–≤–ª–µ–Ω–∞`);
        }
    } else {
        const newPanorama = {
            id: Date.now(),
            name: name,
            description: description,
            location: coords,
            date: date,
            imageUrl: imageUrl,
            details: details,
            icon: icon,
            source: "user",
            panoId: `user_${Date.now()}`
        };
        
        panoramas.push(newPanorama);
        logToConsole(`‚úÖ –ü–∞–Ω–æ—Ä–∞–º–∞ "${name}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`, 'success');
        showNotification(`‚úÖ –ü–∞–Ω–æ—Ä–∞–º–∞ "${name}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`);
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
    setTimeout(async () => {
        await saveCacheFile();
    }, 1000);
    
    updatePanoramasOnMap();
    closeEditor();
}

// ========== –§–£–ù–ö–¶–ò–Ø –£–î–ê–õ–ï–ù–ò–Ø ==========
function deletePanorama(panoramaId) {
    const panorama = panoramas.find(p => p.id === panoramaId);
    if (!panorama) return;
    
    // –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä —Å –∫–∞—Ä—Ç—ã
    if (panoramaMarkers[panoramaId] && map) {
        map.removeLayer(panoramaMarkers[panoramaId]);
        delete panoramaMarkers[panoramaId];
    }
    
    panoramas = panoramas.filter(p => p.id !== panoramaId);
    
    setTimeout(async () => {
        await saveCacheFile();
    }, 1000);
    
    logToConsole(`üóëÔ∏è –ü–∞–Ω–æ—Ä–∞–º–∞ "${panorama?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'}" —É–¥–∞–ª–µ–Ω–∞`, 'warning');
    showNotification(`üóëÔ∏è –ü–∞–Ω–æ—Ä–∞–º–∞ "${panorama?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'}" —É–¥–∞–ª–µ–Ω–∞`);
    
    if (document.getElementById('editor-overlay').style.display === 'block') {
        closeEditor();
    }
}

function closeEditor() {
    document.getElementById('editor-overlay').style.opacity = '0';
    
    setTimeout(() => {
        document.getElementById('editor-overlay').style.display = 'none';
        document.getElementById('editor-overlay').innerHTML = '';
        selectedLocation = null;
        currentEditPanorama = null;
    }, 300);
}

// ========== –ò–°–¢–û–†–ò–Ø –ò –û–ë–ù–û–í–õ–ï–ù–ò–ï ==========
function logToConsole(message, type = 'info') {
    const consoleDiv = document.getElementById('console-content');
    const timestamp = new Date().toLocaleTimeString();
    
    let color = '#00ff00';
    if (type === 'error') color = '#ff4444';
    if (type === 'warning') color = '#ffaa00';
    if (type === 'info') color = '#00ffff';
    
    consoleDiv.innerHTML += `<div style="color:${color}; margin-bottom:5px;">
        <span style="color:#aaa;">[${timestamp}]</span> ${message}
    </div>`;
    
    consoleDiv.scrollTop = consoleDiv.scrollHeight;
    document.getElementById('editor-console').style.display = 'block';
}

function closeConsole() {
    document.getElementById('editor-console').style.display = 'none';
}

function updateHTMLCode() {
    const cleanPanoramas = cleanPanoramaData(panoramas);
    const panoramasCode = `let panoramas = ${JSON.stringify(cleanPanoramas, null, 2)};`;
    const scriptTags = document.getElementsByTagName('script');
    for (let script of scriptTags) {
        const content = script.innerHTML;
        if (content.includes('let panoramas = [')) {
            const startIndex = content.indexOf('let panoramas = [');
            const endIndex = content.indexOf('];', startIndex) + 2;
            
            if (startIndex !== -1 && endIndex !== -1) {
                const newContent = content.substring(0, startIndex) + panoramasCode + content.substring(endIndex);
                script.innerHTML = newContent;
                break;
            }
        }
    }
}

// ========== THREE.JS EARTH ==========
function initEarth() {
    const scene = new THREE.Scene();
    earthScene = scene;
    
    const camera = new THREE.PerspectiveCamera(
        45, 
        window.innerWidth / window.innerHeight, 
        0.1, 
        1000
    );
    
    const renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true
    });
    
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.getElementById('earth').appendChild(renderer.domElement);
    
    const texLoader = new THREE.TextureLoader();
    
    const earthTexture = texLoader.load(
        'https://raw.githubusercontent.com/jeromeetienne/threex.planets/master/images/earthmap1k.jpg',
        function() {
            document.getElementById('loading').style.display = 'none';
            initializePanoramas();
            setupHotkeys();
        }
    );
    
    const cloudsTexture = texLoader.load(
        'https://raw.githubusercontent.com/jeromeetienne/threex.planets/master/images/earthcloudmap.jpg'
    );
    
    const earthGeometry = new THREE.SphereGeometry(5, 64, 64);
    const earthMaterial = new THREE.MeshStandardMaterial({
        map: earthTexture,
        roughness: 0.7,
        metalness: 0.2
    });
    
    const earth = new THREE.Mesh(earthGeometry, earthMaterial);
    scene.add(earth);
    
    const cloudsGeometry = new THREE.SphereGeometry(5.05, 64, 64);
    const cloudsMaterial = new THREE.MeshStandardMaterial({
        map: cloudsTexture,
        transparent: true,
        opacity: 0.4
    });
    
    const clouds = new THREE.Mesh(cloudsGeometry, cloudsMaterial);
    scene.add(clouds);
    
    scene.add(new THREE.AmbientLight(0xffffff, 0.8));
    const sunLight = new THREE.DirectionalLight(0xffffff, 1.5);
    sunLight.position.set(10, 10, 10);
    scene.add(sunLight);
    
    function rotateToCoordinates(lat, lon) {
        const lonRad = (lon * Math.PI) / 180;
        const latRad = (lat * Math.PI) / 180;
        earth.rotation.y = -lonRad - (Math.PI / 2);
        earth.rotation.x = -latRad;
        clouds.rotation.copy(earth.rotation);
    }
    
    rotateToCoordinates(50, 20);
    
    camera.position.set(0, 0, 12);
    let targetZ = 12;
    let targetRotationY = earth.rotation.y;
    let targetRotationX = earth.rotation.x;
    let autoRotate = false;
    
    function animate() {
        requestAnimationFrame(animate);
        
        camera.position.z += (targetZ - camera.position.z) * 0.02;
        earth.rotation.y += (targetRotationY - earth.rotation.y) * 0.02;
        earth.rotation.x += (targetRotationX - earth.rotation.x) * 0.02;
        clouds.rotation.copy(earth.rotation);
        
        renderer.render(scene, camera);
    }
    
    animate();
    
    const zoomSteps = [
        {z: 10, lat: 40, lon: 30, delay: 1000, autoRotate: false},
        {z: 8, lat: 45, lon: 40, delay: 2000, autoRotate: false},
        {z: 6, lat: 48, lon: 60, delay: 3500, autoRotate: false},
        {z: 4.5, lat: 45, lon: 68, delay: 5000, autoRotate: false},
        {z: 3.5, lat: 40.77, lon: 68.3, delay: 7000, autoRotate: false, callback: showMap}
    ];
    
    let currentStep = 0;
    function executeZoomStep(stepIndex) {
        if (stepIndex >= zoomSteps.length) return;
        
        const step = zoomSteps[stepIndex];
        setTimeout(() => {
            targetZ = step.z;
            targetRotationY = (-step.lon * Math.PI / 180) - (Math.PI / 2);
            targetRotationX = -step.lat * Math.PI / 180;
            autoRotate = step.autoRotate;
            
            if (step.callback) {
                setTimeout(step.callback, 1000);
            }
            
            executeZoomStep(stepIndex + 1);
        }, step.delay);
    }
    
    executeZoomStep(0);
    
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        if (map) map.invalidateSize();
        if (modalMap) modalMap.invalidateSize();
        if (panoramaScene) {
            panoramaScene.camera.aspect = window.innerWidth / window.innerHeight;
            panoramaScene.camera.updateProjectionMatrix();
            panoramaScene.renderer.setSize(window.innerWidth, window.innerHeight);
        }
    });
}

// ========== LEAFLET MAP ==========
function showMap() {
    currentView = 'map';
    document.getElementById('earth').style.opacity = '0';
    
    setTimeout(() => {
        document.getElementById('earth').style.display = 'none';
        document.getElementById('map').style.display = 'block';
        
        setTimeout(() => {
            document.getElementById('map').style.opacity = '1';
            initLeafletMap();
        }, 100);
    }, 1500);
}

function initLeafletMap() {
    const jetysaiCoords = [40.77, 68.3];
    
    map = L.map('map', {
        zoomControl: true,
        attributionControl: false,
        dragging: true
    }).setView(jetysaiCoords, 13);
    
    const satelliteWithLabels = L.tileLayer('http://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: ''
    });
    
    const hybridBackup = L.layerGroup();
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: ''
    }).addTo(hybridBackup);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
        maxZoom: 20,
        opacity: 0.8,
        attribution: ''
    }).addTo(hybridBackup);
    
    const regularMap = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: ''
    });
    
    function tryGoogleHybrid() {
        try {
            satelliteWithLabels.addTo(map);
            return true;
        } catch (e) {
            hybridBackup.addTo(map);
            return false;
        }
    }
    
    const googleAvailable = tryGoogleHybrid();
    
    const baseLayers = {
        "üõ∞Ô∏è –°–ø—É—Ç–Ω–∏–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏": googleAvailable ? satelliteWithLabels : hybridBackup,
        "üó∫Ô∏è –û–±—ã—á–Ω–∞—è –∫–∞—Ä—Ç–∞": regularMap
    };
    
    L.control.layers(baseLayers, null, {
        collapsed: false,
        position: 'topright'
    }).addTo(map);
    
    L.control.scale({
        position: 'bottomright',
        imperial: false,
        metric: true
    }).addTo(map);
    
    map.on('click', function(e) {
        if (editMode && currentEditMode === 'add') {
            openEditor(e.latlng);
        }
    });
    
    updatePanoramasOnMap();
    setupUserLocation();
    
    setTimeout(() => {
        document.getElementById('label').style.opacity = '1';
        document.getElementById('label').style.animation = 'pulse 3s infinite';
    }, 1000);
}

// ========== –î–û–ë–ê–í–õ–ï–ù–ò–ï –ú–ê–†–ö–ï–†–ê –ù–ê –ö–ê–†–¢–£ ==========
function addPanoramaToMap(pano) {
    if (!map) return;
    
    const isGooglePano = pano.source === 'google';
    const markerClass = isGooglePano ? 'streetview-marker' : 'panorama-marker';
    const markerColor = isGooglePano ? '#34a853' : '#ff6b6b';
    
    const panoIcon = L.divIcon({
        html: `
            <div class="${markerClass}">
                <div class="icon" style="background: radial-gradient(circle, ${markerColor} 0%, ${markerColor}33 70%); box-shadow: 0 0 20px ${markerColor};">
                    ${pano.icon}
                </div>
            </div>`,
        iconSize: isGooglePano ? [40, 40] : [45, 45],
        iconAnchor: isGooglePano ? [20, 20] : [22.5, 22.5],
        className: 'panorama-icon'
    });
    
    const location = Array.isArray(pano.location) ? pano.location : 
                    (pano.location && pano.location.lat && pano.location.lng) ? 
                    [pano.location.lat, pano.location.lng] : [40.77, 68.3];
    
    const marker = L.marker(location, {
        icon: panoIcon,
        title: pano.name,
        zIndexOffset: 1000,
        riseOnHover: true
    }).addTo(map);
    
    marker.on('mouseover', function() {
        currentPanorama = pano;
        
        const popupContent = `
            <div style="text-align:center; min-width:200px;">
                <h4 style="margin:0 0 5px 0; color:${isGooglePano ? '#34a853' : '#ff6b6b'};">${pano.icon} ${pano.name}</h4>
                <p style="margin:0; font-size:12px;">${pano.description}</p>
                <div style="margin:5px 0; font-size:11px; color:#666;">
                    ${isGooglePano ? '<span style="color:#34a853;">üåç Street View</span>' : '<span style="color:#ff6b6b;">üî¥ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è</span>'}
                </div>
                <div style="margin-top:10px;">
                    <button onclick="event.stopPropagation(); openPanorama(${pano.id})" style="
                        background:${isGooglePano ? '#34a853' : '#ff6b6b'};
                        color:white;
                        border:none;
                        padding:6px 12px;
                        border-radius:4px;
                        cursor:pointer;
                        font-size:12px;
                        width:100%;
                    ">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–∞–Ω–æ—Ä–∞–º—É</button>
                </div>
            </div>
        `;
        
        marker.bindPopup(popupContent).openPopup();
    });
    
    marker.on('click', function(e) {
        currentPanorama = pano;
        
        if (editMode) {
            if (currentEditMode === 'edit') {
                openEditor(null, pano);
            } else if (currentEditMode === 'delete') {
                e.originalEvent.preventDefault();
                e.originalEvent.stopPropagation();
                
                if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø–∞–Ω–æ—Ä–∞–º—É "${pano.name}"?`)) {
                    map.removeLayer(marker);
                    delete panoramaMarkers[pano.id];
                    deletePanorama(pano.id);
                }
            } else {
                openPanorama(pano.id);
            }
        } else {
            openPanorama(pano.id);
        }
    });
    
    panoramaMarkers[pano.id] = marker;
}

function updatePanoramasOnMap() {
    if (map) {
        Object.values(panoramaMarkers).forEach(marker => {
            map.removeLayer(marker);
        });
        panoramaMarkers = {};
    }
    
    panoramas.forEach(pano => {
        addPanoramaToMap(pano);
    });
}

// ========== 360¬∞ –ü–ê–ù–û–†–ê–ú–ê (–¢–û–õ–¨–ö–û –ü–†–û–°–ú–û–¢–†) ==========
function openPanorama(panoId) {
    const pano = panoramas.find(p => p.id === panoId);
    if (!pano) return;
    
    currentPanorama = pano;
    currentView = 'panorama';
    
    document.getElementById('map').style.opacity = '0';
    document.getElementById('back-button').style.display = 'block';
    document.getElementById('select-coords-btn').style.display = 'none';
    document.getElementById('search-streetview-btn').style.display = 'none';
    document.getElementById('cache-manager-btn').style.display = 'none';
    document.getElementById('edit-indicator').style.display = 'none';
    document.getElementById('edit-modes-panel').style.display = 'none';
    
    setTimeout(() => {
        document.getElementById('map').style.display = 'none';
        document.getElementById('panorama-viewer').style.display = 'block';
        
        setTimeout(() => {
            document.getElementById('panorama-viewer').style.opacity = '1';
            initPanoramaViewer(pano);
        }, 100);
    }, 500);
}

function initPanoramaViewer(pano) {
    const viewer = document.getElementById('panorama-viewer');
    while (viewer.firstChild) {
        viewer.removeChild(viewer.firstChild);
    }
    
    try {
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        viewer.appendChild(renderer.domElement);
        
        const geometry = new THREE.SphereGeometry(500, 60, 40);
        geometry.scale(-1, 1, 1);
        
        const textureLoader = new THREE.TextureLoader();
        let textureUrl = pano.imageUrl;
        
        if (!textureUrl.startsWith('http')) {
            textureUrl = window.location.origin + '/' + textureUrl;
        }
        
        textureLoader.load(
            textureUrl,
            function(texture) {
                const material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.BackSide });
                const sphere = new THREE.Mesh(geometry, material);
                scene.add(sphere);
                addPanoramaInfoToViewer(pano);
            },
            undefined,
            function(error) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å 360¬∞ —Ñ–æ—Ç–æ:', error);
                createFallbackPanorama(pano, scene, geometry);
            }
        );
        
        camera.position.set(0, 0, 0.1);
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableZoom = true;
        controls.enablePan = false;
        controls.rotateSpeed = 0.3;
        
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        
        animate();
        
        panoramaScene = { scene, camera, renderer, controls };
        
        window.addEventListener('resize', function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
    } catch (error) {
        viewer.innerHTML = `
            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; color:white; background:rgba(0,0,0,0.8); padding:30px; border-radius:15px;">
                <h2>${pano.icon} ${pano.name}</h2>
                <p>${pano.description}</p>
                <img src="${pano.imageUrl}" style="max-width:300px; border-radius:10px; margin:20px 0;" onerror="this.src='https://via.placeholder.com/300x200/333333/ffffff?text=–§–æ—Ç–æ+–Ω–µ+–∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å'">
                <p><small>${pano.details}</small></p>
                <div style="margin-top:20px;">
                    <button onclick="closePanorama()" style="background:#ff4444; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; margin:5px;">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        `;
    }
}

function createFallbackPanorama(pano, scene, geometry) {
    const color = pano.source === 'google' ? 0x34a853 : 0xff6b6b;
    const material = new THREE.MeshBasicMaterial({ color: color, side: THREE.BackSide, transparent: true, opacity: 0.7 });
    const sphere = new THREE.Mesh(geometry, material);
    scene.add(sphere);
    addPanoramaInfoToViewer(pano, true);
}

function addPanoramaInfoToViewer(pano, isFallback = false) {
    const viewer = document.getElementById('panorama-viewer');
    const oldInfo = document.getElementById('panorama-info');
    if (oldInfo) oldInfo.remove();
    
    const infoDiv = document.createElement('div');
    infoDiv.id = 'panorama-info';
    infoDiv.style.cssText = `
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        border: 2px solid ${pano.source === 'google' ? '#34a853' : '#ff6b6b'};
        max-width: 90%;
        text-align: center;
        z-index: 1000;
        backdrop-filter: blur(10px);
        box-shadow: 0 0 30px rgba(0,0,0,0.5);
    `;
    
    infoDiv.innerHTML = `
        <h3 style="margin:0 0 8px 0; color:${pano.source === 'google' ? '#34a853' : '#ff6b6b'}">${pano.icon} ${pano.name}</h3>
        <p style="margin:0 0 5px 0; font-size:14px;">${pano.description}</p>
        <p style="margin:0; font-size:12px; color:#aaa;">üìç ${pano.location[0].toFixed(6)}, ${pano.location[1].toFixed(6)}</p>
        <p style="margin:0; font-size:12px; color:#aaa;">üìÖ ${pano.date}</p>
        <div style="display:flex; justify-content:center; gap:15px; margin-top:15px;">
            <button onclick="closePanorama()" style="background: #666; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px;">
                <i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
        ${isFallback ? `
        <div style="margin-top:10px; padding:8px; background:rgba(255,100,0,0.2); border-radius:5px; font-size:12px;">
            <i class="fas fa-exclamation-triangle"></i> –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ 360¬∞ —Ñ–æ—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å.
        </div>
        ` : ''}
    `;
    
    viewer.appendChild(infoDiv);
}

function closePanorama() {
    currentView = 'map';
    document.getElementById('panorama-viewer').style.opacity = '0';
    document.getElementById('back-button').style.display = 'none';
    
    setTimeout(() => {
        document.getElementById('panorama-viewer').style.display = 'none';
        document.getElementById('map').style.display = 'block';
        
        setTimeout(() => {
            document.getElementById('map').style.opacity = '1';
            if (editMode) {
                document.getElementById('select-coords-btn').style.display = 'block';
                document.getElementById('search-streetview-btn').style.display = 'block';
                document.getElementById('cache-manager-btn').style.display = 'block';
                document.getElementById('edit-indicator').style.display = 'block';
                document.getElementById('edit-modes-panel').style.display = 'block';
            }
            
            if (panoramaScene) {
                panoramaScene.renderer.dispose();
                panoramaScene = null;
            }
            currentPanorama = null;
        }, 100);
    }, 500);
}

// ========== –§–£–ù–ö–¶–ò–Ø –í–û–ó–í–†–ê–¢–ê ==========
document.getElementById('back-button').addEventListener('click', function() {
    if (currentView === 'panorama') {
        closePanorama();
    } else if (currentView === 'map') {
        showEarth();
    }
});

function showEarth() {
    currentView = 'earth';
    document.getElementById('map').style.opacity = '0';
    document.getElementById('back-button').style.display = 'none';
    document.getElementById('label').style.opacity = '0';
    document.getElementById('label').style.animation = 'none';
    document.getElementById('edit-indicator').style.display = 'none';
    document.getElementById('edit-modes-panel').style.display = 'none';
    document.getElementById('cache-manager-btn').style.display = 'none';
    document.getElementById('cache-panel').style.display = 'none';
    
    setTimeout(() => {
        document.getElementById('map').style.display = 'none';
        if (map) {
            map.remove();
            map = null;
        }
        document.getElementById('earth').style.display = 'block';
        
        setTimeout(() => {
            document.getElementById('earth').style.opacity = '1';
        }, 100);
    }, 1500);
}

// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
document.addEventListener('DOMContentLoaded', () => {
    if (!detectWebGL()) {
        document.getElementById('loading').innerHTML = '‚ùå WebGL –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
        return;
    }
    initEarth();
});

function detectWebGL() {
    try {
        const canvas = document.createElement('canvas');
        return !!(window.WebGLRenderingContext && (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));
    } catch(e) {
        return false;
    }
}

console.log('%cüöÄ –°–∏—Å—Ç–µ–º–∞ 360¬∞ –ø–∞–Ω–æ—Ä–∞–º –ñ–µ—Ç—ã—Å–∞—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'color: #00ff00; font-size: 16px; font-weight: bold;');
console.log('%cüíæ –§–∞–π–ª–æ–≤—ã–π –∫—ç—à: jetysai_panoramas_cache.json', 'color: #9c27b0;');
console.log('%cüìç –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω–æ', 'color: #4285f4;');
console.log('%cüî¥ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–∞–Ω–æ—Ä–∞–º—ã - –∫—Ä–∞—Å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã', 'color: #ff6b6b;');
</script>
</body>
</html>
